# From https://github.com/google/fuzzer-test-suite/tree/master/harfbuzz-1.3.2

get_git_revision() {
  GIT_REPO="$1"
  GIT_REVISION="$2"
  TO_DIR="$3"
  if ! [ -e $TO_DIR ]; then
    git clone $GIT_REPO $TO_DIR
    (cd $TO_DIR && git checkout $GIT_REVISION)
  fi
}

init_target() {
  if ! [ -d c-ares ]; then
    get_git_revision https://github.com/c-ares/c-ares.git 51fbb479f7948fca2ace3ff34a15ff27e796afdd c-ares
    (cd c-ares && ./buildconf)
  fi
}

build_target_and_fuzzer() {
  local name="$1"
  local extra_cflags="$2"
  local extra_ldflags="$3"

  if ! [ -x "target-${name}-build/fuzzer" ]; then
    mkdir -p "target-${name}-build"
    cd "target-${name}-build"

    # Sigh... C-ares, why are you so hard to configure
    cflags=
    cppflags=
    for flag in $DEFAULT_CFLAGS $extra_cflags; do
      if echo "$flag" | grep "^-D"; then
        cppflags="$cppflags $flag"
      else
        cflags="$cflags $flag"
      fi
    done

    ../c-ares/configure CC="$CC" CXX="$CXX" CFLAGS="$cflags" CPPFLAGS="$cppflags" LDFLAGS="$DEFAULT_LDFLAGS $extra_ldflags" \
      2>&1 | tee "../logs/build-${name}.log"
    make -j $N_CORES 2>&1 | tee -a "../logs/build-${name}.log"

    "$CXX" $DEFAULT_CFLAGS $extra_cflags -std=c++11 -I . -I ../c-ares \
      -c "$SCRIPT_DIR/ff-c-ares-CVE-2016-5180.cc" \
      2>&1 | tee -a "../logs/build-${name}.log"
    "$CXX" $DEFAULT_LDFLAGS $extra_ldflags ff-c-ares-CVE-2016-5180.o \
      .libs/libcares.a "$WORK_DIR/Fuzzer-build/libFuzzer.a" -o fuzzer \
      2>&1 | tee -a "../logs/build-${name}.log"
    cd ..
  fi
}
